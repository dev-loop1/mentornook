document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("login-form"),t=document.getElementById("signup-form");e&&e.addEventListener("submit",async t=>{t.preventDefault(),clearAllErrors(e);let r=e.querySelector('button[type="submit"]');r.disabled=!0,r.textContent="Logging in...";let a=document.getElementById("login-email").value,n=document.getElementById("login-password").value,s=!0;if((isEmpty(a)||!validateEmail(a))&&(showError("email-error","Please enter a valid email address."),s=!1),isEmpty(n)&&(showError("password-error","Please enter your password."),s=!1),!s){r.disabled=!1,r.textContent="Login";return}try{let l=await WorkspaceApi("/login/","POST",{username:a,password:n},!1);l.success&&l.data.token?(saveAuthInfo(l.data.token,l.data.user),window.location.href="dashboard.html"):(showGeneralError("login-general-error",l.error||"Login failed. Please check credentials."),r.disabled=!1,r.textContent="Login")}catch(o){console.error("Login error:",o),showGeneralError("login-general-error",o.message||"An unexpected error occurred. Please try again later."),r.disabled=!1,r.textContent="Login"}}),t&&t.addEventListener("submit",async e=>{e.preventDefault(),clearAllErrors(t);let r=t.querySelector('button[type="submit"]');r.disabled=!0,r.textContent="Signing up...";let a=document.getElementById("signup-fullname").value,n=document.getElementById("signup-email").value,s=document.getElementById("signup-password").value,l=document.getElementById("signup-confirm-password").value,o=!0;if(isEmpty(a)&&(showError("fullname-error","Please enter your full name."),o=!1),(isEmpty(n)||!validateEmail(n))&&(showError("email-error","Please enter a valid email address."),o=!1),(isEmpty(s)||!validatePassword(s))&&(showError("password-error","Password must be at least 8 characters long."),o=!1),s!==l&&(showError("confirm-password-error","Passwords do not match."),o=!1),!o){r.disabled=!1,r.textContent="Sign Up";return}let i={username:n,email:n,password:s,first_name:a.split(" ")[0]||"",last_name:a.split(" ").slice(1).join(" ")||""};try{let d=await WorkspaceApi("/register/","POST",i,!1);if(d.success)try{let g=await WorkspaceApi("/login/","POST",{username:n,password:s},!1);g.success&&g.data.token?(saveAuthInfo(g.data.token,g.data.user),window.location.href="profile_setup.html"):(console.warn("Auto-login failed after registration:",g.error),showGeneralError("signup-general-error",`Registration successful, but auto-login failed: ${g.error||"Please log in manually."}`),r.disabled=!1,r.textContent="Sign Up")}catch(u){console.error("Exception during auto-login attempt:",u),showGeneralError("signup-general-error",`Registration successful, but auto-login failed: ${u.message||"Please log in manually."}`),r.disabled=!1,r.textContent="Sign Up"}else{let m=d.error||"Registration failed. Please try again.";if(d.data&&"object"==typeof d.data){let p=Object.entries(d.data).map(([e,t])=>`${e}: ${Array.isArray(t)?t.join(", "):t}`).join("; ");p&&(m=p)}showGeneralError("signup-general-error",m),r.disabled=!1,r.textContent="Sign Up"}}catch(c){console.error("Signup error:",c),showGeneralError("signup-general-error",c.message||"An unexpected error occurred. Please try again later."),r.disabled=!1,r.textContent="Sign Up"}})});