document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("profile-form"),t=document.querySelector(".profile-view-page");e?setupProfileForm():t&&loadProfileView()}));let currentProfileData=null;async function setupProfileForm(){const e=document.getElementById("profile-form"),t=document.getElementById("profile-form-title"),n=document.getElementById("profile-pic-preview"),r=document.getElementById("profile-picture"),o=document.getElementById("delete-profile-button"),i=(document.getElementById("profile-general-error"),e.querySelector('button[type="submit"]'));if(!(e&&i&&t&&r))return void console.error("Profile form setup failed: Essential form elements not found.");if(!getAuthToken())return console.warn("Not authenticated for profile setup. Redirecting to login."),void(window.location.href="login.html");initializeTagInput("profile-skills-container","profile-skills-input","profile-skills-tags","profile-skills"),initializeTagInput("profile-interests-container","profile-interests-input","profile-interests-tags","profile-interests"),i.textContent="Loading Profile...",i.disabled=!0;try{const e=await WorkspaceApi("/profile/","GET",null,!0);e.success&&e.data?(currentProfileData=e.data,t.textContent="Edit Your Profile",populateProfileForm(e.data)):e.success&&null===e.data?(t.textContent="Setup Your Profile",n&&(n.src="assets/images/profile_avatar_default.png"),currentProfileData=null):(showGeneralError("profile-general-error",e.error||"Failed to load profile data."),t.textContent="Setup Your Profile",n&&(n.src="assets/images/profile_avatar_default.png"))}catch(e){console.error("Error loading profile for edit:",e),showGeneralError("profile-general-error","An error occurred while loading your profile."),t.textContent="Setup Your Profile",n&&(n.src="assets/images/profile_avatar_default.png")}finally{i.textContent="Save Profile",i.disabled=!1}r&&n&&r.addEventListener("change",(e=>{const t=e.target.files[0];if(t&&t.type.startsWith("image/")){const e=new FileReader;e.onload=e=>{n.src=e.target.result},e.readAsDataURL(t),clearError("profile-picture-error")}else t&&(showError("profile-picture-error","Please select a valid image file."),n.src=currentProfileData?.profile_picture_url||"assets/images/profile_avatar_default.png",r.value="")})),e.addEventListener("submit",(async t=>{t.preventDefault(),clearAllErrors(e),i.disabled=!0,i.textContent="Saving...";let n=!0;const o=document.getElementById("profile-skills").value,l=document.getElementById("profile-interests").value,s=e.querySelector('input[name="role"]:checked')?.value,a=document.getElementById("profile-bio").value;if(s||(showError("role-error","Please select your role."),n=!1),isEmpty(a)&&(showError("bio-error","Bio cannot be empty."),n=!1),isEmpty(o)&&(showError("skills-error","Skills cannot be empty. Type a skill and press Enter."),n=!1),isEmpty(l)&&(showError("interests-error","Interests cannot be empty. Type an interest and press Enter."),n=!1),!n)return i.disabled=!1,i.textContent="Save Profile",void showGeneralError("profile-general-error","Please fix the errors highlighted above.");const c=new FormData(e),d=r.files[0];let u;const p=document.getElementById("profile-skills").value||"",f=document.getElementById("profile-interests").value||"";d?(u=new FormData,u.append("role",c.get("role")),u.append("headline",c.get("headline")),u.append("bio",c.get("bio")),u.append("skills",p),u.append("interests",f),u.append("location",c.get("location")),u.append("linkedin_url",c.get("linkedin_url")),u.append("website_url",c.get("website_url")),u.append("profile_picture",d,d.name)):u={role:c.get("role"),headline:c.get("headline"),bio:c.get("bio"),skills:p,interests:f,location:c.get("location"),linkedin_url:c.get("linkedin_url"),website_url:c.get("website_url")};try{const e=await WorkspaceApi("/profile/","PUT",u,!0);if(e.success)window.location.href="my_profile.html";else{let t=e.error||"Failed to save profile.";if(e.data&&"object"==typeof e.data){const n=Object.entries(e.data).map((([e,t])=>`${e}: ${Array.isArray(t)?t.join(", "):t}`)).join("; ");n&&(t=n)}showGeneralError("profile-general-error",t),i.disabled=!1,i.textContent="Save Profile"}}catch(e){console.error("Error saving profile:",e),showGeneralError("profile-general-error",e.message||"An unexpected error occurred."),i.disabled=!1,i.textContent="Save Profile"}})),o?o.addEventListener("click",(async()=>{if(confirm("Are you sure you want to delete your profile? This action cannot be undone and will log you out.")){o.disabled=!0,o.textContent="Deleting...";try{const e=await WorkspaceApi("/profile/","DELETE",null,!0);e.success||204===e.status?(alert("Profile deleted successfully."),clearAuthInfo(),window.location.href="index.html"):(alert(`Failed to delete profile: ${e.error||"Unknown error"}`),o.disabled=!1,o.textContent="Delete Profile")}catch(e){console.error("Error deleting profile:",e),alert(`An error occurred: ${e.message||"Please try again."}`),o.disabled=!1,o.textContent="Delete Profile"}}})):console.warn("Delete profile button not found.")}function populateProfileForm(e){if(!e)return;const t=document.querySelector(`input[name="role"][value="${e.role}"]`);t?t.checked=!0:e.role&&console.warn(`Could not find radio button for role: ${e.role}`);const n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=t||"")};n("profile-headline",e.headline),n("profile-bio",e.bio),n("profile-location",e.location),n("profile-linkedin",e.linkedin_url),n("profile-website",e.website_url);const r=document.getElementById("profile-pic-preview");r&&(r.src=e.profile_picture_url||"assets/images/profile_avatar_default.png");const o=document.getElementById("profile-skills"),i=document.getElementById("profile-interests");o&&(o.value=e.skills_list&&Array.isArray(e.skills_list)?e.skills_list.join(","):""),i&&(i.value=e.interests_list&&Array.isArray(e.interests_list)?e.interests_list.join(","):"");const l=document.getElementById("profile-skills-container"),s=document.getElementById("profile-interests-container");l?.refreshTags&&l.refreshTags(),s?.refreshTags&&s.refreshTags()}async function loadProfileView(){const e=document.getElementById("profile-content"),t=document.getElementById("loading-profile-message"),n=document.getElementById("error-profile-message");if(!e||!t||!n)return void console.error("Profile view elements not found.");const r=getUrlParams().id,o=getUserInfo(),i=!r||o&&String(r)===String(o.id),l=i?o?.id:r;if(!l)return t.style.display="none",n.textContent="Could not determine which profile to load.",n.style.display="block",void(i&&!o&&(window.location.href="login.html"));t.style.display="block",e.style.display="none",n.style.display="none";try{const t=i?"/profile/":`/profiles/${l}/`,r=!0,s=await WorkspaceApi(t,"GET",null,r);s.success&&s.data?(renderProfileData(s.data,i,o?.id),e.style.display="block"):(n.textContent=s.error||"Profile could not be loaded.",n.style.display="block")}catch(e){console.error("Error loading profile view:",e),n.textContent=e.message||"An unexpected error occurred.",n.style.display="block"}finally{t.style.display="none"}}function renderProfileData(e,t,n){if(!e||!e.user)return console.error("Invalid profile data received for rendering:",e),setTextContent("error-profile-message","Failed to render profile: Invalid data."),void setVisible(document.getElementById("error-profile-message"),!0);const r=n?String(n):null,o=String(e.user.id),i=e.name||e.user.username;document.title=t?"My Profile - MentorNook":`${i}'s Profile - MentorNook`;const l=document.getElementById("profile-view-picture");l&&(l.src=e.profile_picture_url||"assets/images/profile_avatar_default.png",l.alt=`${i}'s profile picture`),setTextContent("profile-view-name",i),setTextContent("profile-view-headline",e.headline||"No headline provided");const s=document.getElementById("profile-view-role");s&&(s.textContent=e.role||"Role not specified",s.className="user-role",e.role&&s.classList.add(e.role)),setTextContent("profile-view-bio",e.bio||"No bio provided."),renderTags("profile-view-skills",e.skills_list,"skills"),renderTags("profile-view-interests",e.interests_list,"interests");const a=document.getElementById("profile-view-location"),c=document.getElementById("profile-view-linkedin"),d=document.getElementById("profile-view-website");setVisible(a,!!e.location),e.location&&a&&(a.textContent=`Location: ${e.location}`),setVisible(c,!!e.linkedin_url),e.linkedin_url&&c&&(c.innerHTML=`LinkedIn: <a href="${e.linkedin_url}" target="_blank" rel="noopener noreferrer">View Profile</a>`),setVisible(d,!!e.website_url),e.website_url&&d&&(d.innerHTML=`Website: <a href="${e.website_url}" target="_blank" rel="noopener noreferrer">${e.website_url}</a>`);const u=document.getElementById("connection-action-area"),p=document.querySelector(".edit-profile-btn");t?(setVisible(p,!0),setVisible(u,!1)):(setVisible(p,!1),setVisible(u,!0),u&&setupConnectionButton(u,o,e.connectionStatus,r))}function setupConnectionButton(e,t,n,r){if(!e)return void console.error("setupConnectionButton: Action area container not found.");if(e.innerHTML="",!r||String(r)===String(t)||"self"===n)return;let o,i,l=document.createElement("div");switch(l.style.display="flex",l.style.gap="0.5rem",n){case"pending_sent":i=document.createElement("p"),i.className="connection-status",i.textContent="Request Sent",e.appendChild(i),o=document.createElement("button"),o.className="btn btn-warning btn-sm",o.textContent="Cancel Request",o.dataset.action="cancel",o.dataset.targetUserId=t,e.appendChild(o);break;case"pending_received":i=document.createElement("p"),i.className="connection-status",i.textContent="Request Received",e.appendChild(i);const n=document.createElement("button");n.className="btn btn-success btn-sm",n.textContent="Accept",n.dataset.action="accept",n.dataset.targetUserId=t,l.appendChild(n);const r=document.createElement("button");r.className="btn btn-danger btn-sm",r.textContent="Decline",r.dataset.action="decline",r.dataset.targetUserId=t,l.appendChild(r),e.appendChild(l);break;case"connected":i=document.createElement("p"),i.className="connection-status",i.textContent="Connected",e.appendChild(i),o=document.createElement("button"),o.className="btn btn-danger btn-sm",o.textContent="Remove Connection",o.dataset.action="remove",o.dataset.targetUserId=t,e.appendChild(o);break;default:o=document.createElement("button"),o.id="send-request-btn",o.className="btn btn-primary",o.textContent="Send Mentorship Request",o.dataset.action="send",o.dataset.targetUserId=t,e.appendChild(o)}const s=document.getElementById("connection-action-area");s&&!s.dataset.listenerAttached?(s.removeEventListener("click",handleConnectionActionClick),s.addEventListener("click",handleConnectionActionClick),s.dataset.listenerAttached="true"):s||console.error("Could not find #connection-action-area to attach listener.")}async function handleConnectionActionClick(e){const t=e.target.closest("button[data-action]");if(!t||t.disabled)return;const n=t.dataset.action,r=t.dataset.targetUserId,o=getAuthToken(),i=t.closest("#connection-action-area"),l=getUserInfo();if(!(n&&r&&o&&i&&l))return console.error("Connection action cannot proceed: Missing required data."),void alert("Cannot perform action. Please ensure you are logged in.");const s=i.querySelectorAll("button");s.forEach((e=>e.disabled=!0));const a=t.textContent;t.textContent="Processing...";try{let e,o,c,d=null;if("send"!==n){const e=await WorkspaceApi("/connections/","GET",null,!0);if(e.success&&e.data){const{incoming:t=[],outgoing:n=[],current:o=[]}=e.data,i=[...t,...n,...o].find((e=>String(e.requester?.id)===String(l.id)&&String(e.receiver?.id)===String(r)||String(e.receiver?.id)===String(l.id)&&String(e.requester?.id)===String(r)));d=i?.id}if(!d){console.warn(`Could not find relevant connection for action '${n}' - attempting profile refresh.`);const e=await WorkspaceApi(`/profiles/${r}/`,"GET",null,!0);if(!e.success||!e.data)throw new Error(`Could not find connection involving user ${r} to perform action '${n}', and failed to refresh state.`);return void setupConnectionButton(i,r,e.data.connectionStatus,l.id)}}let u=null;switch(n){case"send":o="POST",c="/connections/request/",u={user_id:r};break;case"accept":case"decline":o="PUT",c=`/connections/${d}/`,u={action:n};break;case"cancel":case"remove":o="DELETE",c=`/connections/${d}/`,u=null;break;default:throw new Error(`Unknown connection action: ${n}`)}if(e=await WorkspaceApi(c,o,u,!0),e.success||204===e.status){const e=`/profiles/${r}/`;try{const t=await WorkspaceApi(e,"GET",null,!0);t.success&&t.data?setupConnectionButton(i,r,t.data.connectionStatus,l.id):(console.error("Failed to refresh profile after connection action:",t.error),i.innerHTML='<p class="error-message">Action successful, but failed to refresh button status.</p>')}catch(e){console.error("Exception during profile refresh after connection action:",e),i.innerHTML=`<p class="error-message">Action successful, but failed to refresh button status: ${e.message}</p>`}}else alert(`Action failed: ${e.error||"Unknown error"}`),s.forEach((e=>e.disabled=!1)),t.textContent=a}catch(e){console.error(`Error performing connection action '${n}' for user ${r}:`,e),alert(`An error occurred: ${e.message||"Please try again."}`),s.forEach((e=>e.disabled=!1)),t.textContent=a}}function setTextContent(e,t){const n=document.getElementById(e);n?n.textContent=t:console.error(`!!! Element with ID "${e}" NOT FOUND for setTextContent.`)}function setVisible(e,t){e&&(e.style.display=t?"":"none")}function renderTags(e,t,n="items"){const r=document.getElementById(e);if(r)if(r.innerHTML="",t&&Array.isArray(t)&&t.length>0)t.forEach((e=>{if(e&&""!==e.trim()){const t=document.createElement("span");t.className="tag",t.textContent=e.trim(),r.appendChild(t)}}));else{const e=document.createElement("p");e.textContent=`No ${n} listed.`,e.style.color="var(--muted-color)",e.style.fontStyle="italic",r.appendChild(e)}else console.error(`!!! Container with ID "${e}" NOT FOUND for renderTags.`)}